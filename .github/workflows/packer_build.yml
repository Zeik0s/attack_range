name: packer build images
on:
  push:
    branches:
    - attack_range_3

jobs:
  packer:
    runs-on: ubuntu-latest
    name: packer build images

    steps:
      - name: Checkout repo
        uses: actions/checkout@v2

      - uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-central-1

      - uses: actions/setup-python@v2
        with:
          python-version: '3.9' 
          architecture: 'x64' 

      - name: Install Python dependencies
        run: |
          python3 -m pip install ansible requests pywinrm

      - name: Install Packer
        run: |
          curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
          sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
          sudo apt-get update && sudo apt-get install packer

      - name: Build Packer Image Splunk
        run: |
          cd packer
          packer build -only=amazon-ebs.windows splunk_server/splunk-ubuntu.pkr.hcl
          cd ..

      - name: Build Packer Image Windows 2016
        run: |
          cd packer
          packer build -only=amazon-ebs.windows windows_server/windows_2016.pkr.hcl
          cd ..

      - name: Build Packer Image Windows 2019
        run: |
          cd packer
          packer build -only=amazon-ebs.windows windows_server/windows_2019.pkr.hcl
          cd ..

      - name: Build Packer Image Linux Server
        run: |
          cd packer
          packer build -only=amazon-ebs.windows linux_server/linux-ubuntu-18-04.pkr.hcl
          cd ..

      - name: Build Packer Image Nginx
        run: |
          cd packer
          packer build -only=amazon-ebs.windows nginx_server/nginx_web_proxy.pkr.hcl
          cd ..